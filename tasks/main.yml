---

# Ensure the log directory and file exists
- name: Ensure /var/log directory exists
  ansible.builtin.file:
    path: /var/log
    state: directory
    mode: '0755'

- name: Check if {{ pika_log_file }} exists
  ansible.builtin.stat:
    path: "{{ pika_log_file }}"
  register: pika_log_file_stat

- name: Create {{ pika_log_file }} if it does not exist
  ansible.builtin.file:
    path: "{{ pika_log_file }}"
    state: touch
    mode: '0666'
  when: not pika_log_file_stat.stat.exists  

- name: Ensure correct permissions on {{ pika_log_file }}
  ansible.builtin.file:
    path: "{{ pika_log_file }}"
    mode: '0666'
  when: pika_log_file_stat.stat.exists and pika_log_file_stat.stat.mode != '0666'

- name: Ensure the pre-backup script is present
  ansible.builtin.template:
    src: pre_backup.sh.j2
    dest: "{{ pre_backup_script_location }}"
    mode: '0755'
  register: pre_backup_script
  changed_when: pre_backup_script.changed

- name: Install Flatpak
  ansible.builtin.dnf:
    name: flatpak
    state: present

- name: Add Flathub repository
  community.general.flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo

- name: Install Pika Backup
  community.general.flatpak:
    name: org.gnome.World.PikaBackup
    state: present
    remote: flathub

- name: Ensure the Pika Backup service override directory exists
  ansible.builtin.file:
    path: /etc/systemd/system/pika-backup.service.d
    state: directory

- name: Configure Pika Backup to use pre-backup script
  ansible.builtin.copy:
    dest: /etc/systemd/system/pika-backup.service.d/override.conf
    content: |
      [Service]
      ExecStartPre="{{ pre_backup_script_location }}"
  notify: reload systemd
  register: pika_backup_override
  changed_when: pika_backup_override.changed
